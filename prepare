#!/bin/bash

set -x

currentDir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
source "${currentDir}/base.sh"

TEMP=$(mktemp -d)
git clone https://github.com/osbuild/gitlab-ci-terraform.git "$TEMP"

MAX_JOBS=$(cat "$TEMP/${CUSTOM_ENV_RUNNER}/config.json" | jq -r .maxInstances)

if [[ $MAX_JOBS != "null" ]]; then
  while true; do
    COUNT=$(ls "$RUNNER_DIR" | wc -l)
    if [[ $COUNT < $MAX_JOBS ]]; then
      break
    fi
    echo Waiting for a free runner slot...
    sleep 1
  done
fi

mv "$TEMP/${CUSTOM_ENV_RUNNER}" "$TERRAFORM_JOB"
rm -rf "$TEMP"

$TERRAFORM init
$TERRAFORM apply -auto-approve

VM_IP=$($TERRAFORM output -json | jq -r .instance_ips.value[0])

echo "Waiting for sshd to be available"
for i in $(seq 1 90); do
    if $SSH "$(sshUser)@${VM_IP}" >/dev/null 2>/dev/null; then
        break
    fi

    if [ "$i" == "90" ]; then
        echo 'Waited 90 seconds for sshd to start, exiting...'
        # Inform GitLab Runner that this is a system failure, so it
        # should be retried.
        exit "$SYSTEM_FAILURE_EXIT_CODE"
    fi

    sleep 1s
done

set -x
SUBSCRIPTION_REQUIRED=$(cat "${TERRAFORM_JOB}/config.json" | jq -r '.subscriptionNeeded')

if [[ $SUBCRIPTION_REQUIRED == "true" ]]; then
  set +x
  echo "${CUSTOM_ENV_RHN_REGISTRATION_SCRIPT}" | $SSH "$(sshUser)@${VM_IP}"
fi

$SSH "$(sshUser)@${VM_IP}" sudo dnf install -y git-core https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner_$(runnerArch).rpm
